<ol class="breadcrumb">
    <li><a href="/index.php?controller=backend">Home</a></li>
    <li><a href="index.php?module=quanlythuoc&controller=phieuxuatnhap&action=index"> Danh Sách Phiếu</a></li>
    <li> Thêm Phiếu </li>
</ol>
<?php


use Module\quanlythuoc\Model\DanhMuc;
use Module\quanlythuoc\Model\DanhMuc\FormDanhMuc;
use Module\quanlythuoc\Model\PhieuXuatNhap;
use Module\quanlythuoc\Model\PhieuXuatNhap\FormPhieuXuatNhap;
use Module\quanlythuoc\Model\PhieuXuatNhapChiTiet;
use Module\quanlythuoc\Model\SanPham;

$roleDetail = new Model\Role();
?>
<div class="container-fluid">
    <div class="box box-primary">
        <div class="box-header">
            <h3 class="box-title">Thêm Phiếu</h3>
            <!-- <div class="box-tools">
                <?php
                Module\quanlythuoc\Model\btnHtml::btnViewDanhMuc();
                ?>
            </div> -->
        </div>
        <form action="" method="post" onsubmit="return confirm('Bạn có chắc thông tin đã nhập chính xác?')" enctype="multipart/form-data">
            <div class="box-body">
                <?php
                $phieu = new FormPhieuXuatNhap();
                ?>
                <div class="row">
                    <div class="col-md-4">
                        <?php $phieu->IdPhieu()->renderHtml(); ?>
                    </div>
                    <div class="col-md-4">
                        <?php $phieu->XuatNhap()->renderHtml(); ?>
                    </div>
                    <div class="col-md-4">
                        <?php $phieu->NgayNhap(date("Y-m-d", time()))->renderHtml();  ?>
                    </div>
                    <div class="col-md-6">
                        <?php $phieu->NoiDungPhieu()->renderHtml();  ?>
                    </div>
                    <div class="col-md-6">
                        <?php $phieu->GhiChu()->renderHtml();  ?>
                    </div>
                    <div class="col-md-12">
                        <fieldset>
                            <legend>Danh Sách Thuốc</legend>
                            <div>
                                <button data-toggle="tooltip" data-placement="top" title="Thêm thuốc" type="button" class="btn btn-success" id="btn-addrow">
                                    <i class="fa fa-plus" aria-hidden="true"></i>
                                </button>

                                <a class="btn pull-right btn-primary" data-toggle="modal" href='#modal-huongdan'>
                                    <i class="fa fa-info" aria-hidden="true"></i>
                                    Hướng dẫn
                                </a>
                                <div class="modal fade" id="modal-huongdan">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                                <h4 class="modal-title">Hướng dẫn</h4>
                                            </div>
                                            <div class="modal-body">
                                                <?php
                                                if (file_exists("public\huongdan\huongdanthemphieu.html"))
                                                    echo file_get_contents("public\huongdan\huongdanthemphieu.html");
                                                ?>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                                <button type="button" class="btn btn-primary">Save changes</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th style="width: 50px"></th>
                                        <th>STT</th>
                                        <th>Thuốc</th>
                                        <th style="width: 100px">ĐVT</th>
                                        <th style="width: 100px">
                                            <i class="pull-right fa fa-info" data-toggle="tooltip" data-placement="top" title="Số lượng sản phẩm nhập vào"></i>
                                            Số Lượng
                                        </th>
                                        <th style="width: 100px">
                                            <i class="pull-right fa fa-info" data-toggle="tooltip" data-placement="top" title="Số lô sản phẩm"></i>
                                            Số Lô
                                        </th>
                                        <th>Nhà Sản Xuất
                                        </th>
                                        <th style="width: 300px">
                                            <i class="pull-right fa fa-info" data-toggle="tooltip" data-placement="top" title="Nơi sản xuất"></i>
                                            Nước Sản Xuất
                                        </th>
                                        <th style="width: 140px">
                                            <i class="pull-right fa fa-info" data-toggle="tooltip" data-placement="top" title="Giá nhập của 1 sản phẩm"></i>
                                            Giá
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="table-thuoc">

                                    <?php
                                    // var_dump(PhieuXuatNhap::DSThuocPhieuNhap());
                                    $index = 1;
                                    foreach (PhieuXuatNhap::DSThuocPhieuNhap() as $mathuoc => $thuoc) {
                                        $sanPham = new SanPham($thuoc);
                                        $i = $mathuoc;
                                    ?>
                                        <tr>
                                            <th>
                                                <button data-toggle="tooltip" data-placement="top" title="Xóa thuốc" type="button" title="Xóa thuốc này?" class="btn  btn-danger deleterow" id="<?php echo 'delete' . $i ?>" index=<?php echo $i ?>>
                                                    <i class="fa fa-minus" aria-hidden="true"></i>
                                                </button>
                                            </th>
                                            <th>
                                                <?php echo $index++; ?>
                                            </th>
                                            <th style="width: 200px;">
                                                <?php echo $phieu->IdThuoc($thuoc["Id"] ?? "", "IdThuoc" . $i, $i)->render() ?>
                                            </th>
                                            <th>
                                                <?php
                                                echo $phieu->DVT($sanPham->DonViTinh(), "DVT" . $i, $i)->render(); ?>
                                            </th>
                                            <th>
                                                <?php echo $phieu->SoLuong($sanPham->Soluong, "SoLuong" . $i, $i)->render(); ?>
                                            </th>
                                            <th>
                                                <?php echo $phieu->SoLo($sanPham->Soluong, "SoLo" . $i, $i)->render(); ?>
                                            </th>
                                            <th>
                                                <?php echo $phieu->NhaSanXuat($sanPham->NhaSX, "NhaSanXuat" . $i, $i)->render(); ?>
                                            </th>
                                            <th>
                                                <?php echo $phieu->NuocSanXuat($sanPham->NuocSX, "NuocSanXuat" . $i, $i)->render(); ?>
                                            </th>
                                            <th>
                                                <?php echo $phieu->Price($sanPham->Giaban, "Price" . $i, $i)->render(); ?>
                                            </th>
                                        </tr>
                                    <?php
                                    }
                                    ?>
                                </tbody>
                            </table>
                        </fieldset>
                    </div>

                    <div class="col-md-12 ">
                        <button class="btn btn-warning" type="reset">Làm Lại</button>
                        <!-- <button class="btn btn-success">Lưu</button> -->
                        <button class="btn btn-success" name="LuuThoat">Thêm Mới</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    $(document).ready(function() {

        // Xóa SESSION
        $(".deleterow").click(function() {
            var index = $("#" + $(this).attr("id")).attr("index");
            // var TongNgayDungThuoc = $("#TongNgayDungThuoc").val();
            $.ajax({
                url: `/quanlythuoc/phieuxuatnhap/DeleteSP/${index}/`,
                type: 'Get',
                // data:{$id : $id},
                //dataType: 'json',
                contentType: false,
                processData: false,
                success: function(response) {
                    window.location.reload();
                    console.log(response);
                },
                complete: function() {
                    //spinner.close();
                }
            });
        });

        // Thêm SESSION
        $("#btn-addrow").click(function() {
            // var index = $("#" + $(this).attr("id")).attr("index");
            // alert("index");
            // var TongNgayDungThuoc = $("#TongNgayDungThuoc").val();
            $.ajax({
                url: `/quanlythuoc/phieuxuatnhap/ThemSanPham/`,
                type: 'post',
                // data:{$id : $id},
                //dataType: 'json',
                contentType: false,
                processData: false,
                success: function(response) {
                    window.location.reload();
                    console.log(response);
                },
                complete: function() {
                    //spinner.close();
                }
            });
        })

        // Change Thuốc
        $(".changename").each(function(index, e) {
            // console.log(e.attr("id"));
            $(this).change(function(param) {
                // console.log($(this).attr("id")); // Lấy Id thuốc
                $($(this).attr("id")).val();
                // console.log($("#"+$(this).attr("id")).val()); // Lấy Mã Thuốc
                // console.log($("#" + $(this).attr("id")).attr("index")); // Lấy index thuốc
                var idName = "#" + $(this).attr("id");
                var idDVT = "#DVT" + $("#" + $(this).attr("id")).attr("index");
                var idSoLuong = "#SoLuong" + $("#" + $(this).attr("id")).attr("index");
                var idSoLo = "#SoLo" + $("#" + $(this).attr("id")).attr("index");
                var idNhaSanXuat = "#NhaSanXuat" + $("#" + $(this).attr("id")).attr("index");
                var idNuocSanXuat = "#NuocSanXuat" + $("#" + $(this).attr("id")).attr("index");
                var idPrice = "#Price" + $("#" + $(this).attr("id")).attr("index");
                var index = $("#" + $(this).attr("id")).attr("index");
                var idThuoc = $(idName).val();
                $.ajax({
                    url: `/quanlythuoc/phieuxuatnhap/capnhatdanhsachsanpham/${idThuoc}/${index}/`,
                    type: 'get',
                    contentType: false,
                    processData: false,
                    success: function(response) {
                        $(idSoLuong).val(response.Soluong);
                        $(idSoLo).val(response.SoLo);
                        $(idNhaSanXuat).val(response.NhaSX);
                        $(idNuocSanXuat).val(response.NuocSX);
                        $(idPrice).val(response.Gianhap);
                        $(idDVT).val(response.DVTTitle);
                    },
                    complete: function() {
                        //spinner.close();
                    }
                });
            });
        });
        $(".changenum").each(function(index, e) {
            $(this).change(function(param) {
                $($(this).attr("id")).val();
                // console.log($("#"+$(this).attr("id")).val()); // Lấy Mã Thuốc
                // console.log($("#" + $(this).attr("id")).attr("index")); // Lấy index thuốc
                var idName = "#" + $(this).attr("id");
                var idDVT = "#DVT" + $("#" + $(this).attr("id")).attr("index");
                var idSoLuong = "#SoLuong" + $("#" + $(this).attr("id")).attr("index");
                var idSoLo = "#SoLo" + $("#" + $(this).attr("id")).attr("index");
                var idNhaSanXuat = "#NhaSanXuat" + $("#" + $(this).attr("id")).attr("index");
                var idNuocSanXuat = "#NuocSanXuat" + $("#" + $(this).attr("id")).attr("index");
                var idPrice = "#Price" + $("#" + $(this).attr("id")).attr("index");
                var index = $("#" + $(this).attr("id")).attr("index");
                var idThuoc = $(idName).val();
                $.ajax({
                    url: `/quanlythuoc/phieuxuatnhap/capnhatsanpham/`,
                    type: 'post',
                    data: JSON.stringify({
                        "index": index,
                        "soLuong": $(idSoLuong).val(),
                        "nhaSanXuat": $(idNhaSanXuat).val(),
                        "nuocSanXuat": $(idNuocSanXuat).val(),
                        "soLo": $(idSoLo).val(),
                        "gia": $(idPrice).val(),
                    }),
                    contentType: false,
                    processData: false,
                    success: function(response) {
                        $(idSoLuong).val(response.Soluong);
                        $(idSoLo).val(response.Solo);
                        $(idNhaSanXuat).val(response.NhaSX);
                        $(idNuocSanXuat).val(response.NuocSX);
                        $(idPrice).val(response.Giaban);
                    },
                    complete: function() {
                        //spinner.close();
                    }
                });
            });
        });
    });
</script>